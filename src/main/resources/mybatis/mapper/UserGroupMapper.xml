<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.BlueStrongMountain.repository.mapper.UserGroupMapper">

    <!-- ResultMap: id/status는 도메인에 없으므로 제외 -->
    <resultMap id="UserGroupMap" type="com.ssafy.BlueStrongMountain.domain.UserGroup">
        <result property="userId" column="user_id"/>
        <result property="groupId" column="group_id"/>
        <result property="role" column="role"/>
        <result property="joinedAt" column="joined_at"/>
    </resultMap>

    <!-- INSERT -->
    <!-- id/status는 자동 처리되므로 입력 안함 -->
    <insert id="insert">
        INSERT INTO user_groups
            (user_id, group_id, role, joined_at)
        VALUES
            (#{userId}, #{groupId}, #{role}, #{joinedAt})
    </insert>

    <!-- SELECT: findByUserId -->
    <select id="findByUserId" resultMap="UserGroupMap">
        SELECT user_id, group_id, role, joined_at
        FROM user_groups
        WHERE user_id = #{userId}
    </select>

    <!-- SELECT: findByGroupId -->
    <select id="findByGroupId" resultMap="UserGroupMap">
        SELECT user_id, group_id, role, joined_at
        FROM user_groups
        WHERE group_id = #{groupId}
    </select>

    <!-- SELECT: findByUserIdAndGroupId -->
    <select id="findByUserIdAndGroupId" resultMap="UserGroupMap">
        SELECT user_id, group_id, role, joined_at
        FROM user_groups
        WHERE user_id = #{userId}
          AND group_id = #{groupId}
    </select>

    <!-- SELECT: findByGroupIdAndRole -->
    <select id="findByGroupIdAndRole" resultMap="UserGroupMap">
        SELECT user_id, group_id, role, joined_at
        FROM user_groups
        WHERE group_id = #{groupId}
          AND role = #{role}
    </select>

    <!-- UPDATE role 변경 -->
    <update id="updateRole">
        UPDATE user_groups
        SET role = #{role}
        WHERE user_id = #{userId}
          AND group_id = #{groupId}
    </update>

    <!-- DELETE -->
    <delete id="deleteByUserIdAndGroupId">
        DELETE FROM user_groups
        WHERE user_id = #{userId}
          AND group_id = #{groupId}
    </delete>

    <!-- BULK DELETE -->
    <delete id="deleteByGroupIdAndUserIds">
        DELETE FROM user_groups
        WHERE group_id = #{groupId}
        AND user_id IN
        <foreach collection="userIds" item="uid" open="(" separator="," close=")">
            #{uid}
        </foreach>
    </delete>

    <!-- COUNT -->
    <select id="countByGroupIdAndRole" resultType="int">
        SELECT COUNT(*)
        FROM user_groups
        WHERE group_id = #{groupId}
          AND role = #{role}
    </select>

</mapper>
